<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>日次売上金集金フォーム</title>
  <style>
    :root{--colWidth:64px; --valueCol:80px}
    body { font-family: Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background:#f7f9fc; padding:4px; color:#111; }
    .container { max-width:1200px; margin:0 auto; background:#fff; padding:8px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
    h1 { margin:0 0 6px; font-size:1.18rem; }
    .subtitle { color:#546e7a; margin-bottom:12px; }
    label { display:block; margin:12px 0 6px; font-weight:700; font-size:0.9rem;}
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
      width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; box-sizing:border-box; font-size:0.8rem;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:180px; }
    .actions { margin-top:18px; text-align:right; }
    button { background:#0b69d6; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-size:0.95rem; }
    .note { color:#666; font-size:0.8rem; margin-top:8px; }

    /* login box */
    #loginBox { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    #loginBox input { width:auto; display:inline-block; padding:6px 8px; font-size:0.8rem; }
    #loginBox button { padding:6px 10px; font-size:0.9rem; }

    /* grid */
    .grid-wrapper { width:100%; overflow-x:auto; border:1px solid #e6eef8; border-radius:8px; background:#fff; margin-top:10px; }
    table.grid { border-collapse:collapse; table-layout:fixed; min-width:100%; }
    .grid th, .grid td { border-right:1px solid #eef6ff; border-bottom:1px solid #eef6ff; padding:8px 6px; text-align:center; font-size:0.8rem; white-space:nowrap; }
    .grid th { background:#f0f6ff; color:#0b69d6; font-weight:700; position:sticky; top:0; z-index:5; }
    .grid th:first-child, .grid td:first-child { position:sticky; left:0; z-index:7; background:#fff; text-align:left; padding-left:12px; min-width:var(--valueCol); }
    .count-cell { width:var(--colWidth); max-width:var(--colWidth); padding:6px; }
    .inline-input { width:72px; padding:6px; border-radius:6px; border:1px solid #cbd6e6; font-size:0.8rem; }
    .inline-input::placeholder { font-size:0.8rem; }
    .note-input { width:100%; padding:6px; border-radius:6px; border:1px solid #cbd6e6; font-size:0.8rem; }
    .note-input::placeholder { font-size:0.8rem; }
    .cash-box { margin-top:12px; font-weight:700; color:#ff3300; }
    .total-box { margin-top:12px; font-weight:700; color:#0b69d6; }
    .help { color:#555; font-size:0.80rem; margin-top:6px; }

    /* ①−⑥ 表示用 */
    .delta-box {
      margin-top:6px;
      font-weight:700;
      color:#0f766e;              /* 落ち着いた緑 */
      background:#ecfeff;         /* 淡い背景 */
      /*border:1px solid #99f6e4;   /* 輪郭 */*/
      border-radius:8px;
      padding:8px 10px;
    }

    @media (max-width:700px){
      :root{--valueCol:40px; --colWidth:48px}
      .container { padding:12px; }
    }

    /* Login block — vertical layout */
    #loginBox { display: block; margin-bottom: 12px; padding: 8px 0; }
    #loginBox .field { margin-top: 8px; }
    #loginBox .field input {
      width:100%; padding:4px 4px; border-radius:6px; border:1px solid #d1d5db; box-sizing:border-box; font-size:0.95rem;
    }
    #loginBox .actions { display:flex; gap:8px; margin-top:10px; justify-content:flex-start; }
    #loginBox .pass { width:40%; }
  </style>
</head>
<body>
  <div class="container">
    <h1>売上集金｜Tổng kết sổ</h1>

    <form id="dailyCashForm" onsubmit="return false;">
      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label for="date">日付｜Date</label>
          <input type="date" id="date" name="date" required />
        </div>
      </div>

      <div class="row" style="margin-top:4px;">
        <div class="col">
          <label for="location">店舗｜Tên Tiệm</label>
          <select id="location" name="location" required>
            <option value=""></option>
            <option value="Tsujido">辻堂店｜Tsujido</option>
            <option value="Tsutsumi">堤店｜Tsutsumi</option>
            <!-- <option value="other">その他</option> -->
          </select>
          <input type="text" id="locationOther" placeholder="店舗名を入力" style="margin-top:8px; display:none;" />
        </div>
      </div>

      <div class="row" style="margin-top:4px;">
        <div class="col">
          <label for="cashier">担当者｜Member</label>
          <select id="cashier" name="cashier" required>
            <option value=""></option>
            <option value="Hayasaka">Hayasaka</option>
            <option value="Huyen">Huyen</option>
            <option value="Quyen">Quyen</option>
            <option value="Thuy">Thuy</option>
            <option value="Thi">Thi</option>
            <option value="Nguyen">Nguyen</option>
            <option value="Lam">Lam</option>
          </select>
          <input type="text" id="cashierOther" placeholder="担当者名を入力" style="margin-top:8px; display:none;" />
        </div>
      </div>

      <!-- ① レジ現金 -->
      <label style="margin-top:12px;">① レジ現金｜Tiền Mặt </label>
      <div class="help">額と数を選択｜Chọn tiền và số lượng</div>

      <div class="grid-wrapper" id="gridWrapper">
        <table class="grid" id="cashGrid">
          <thead id="gridHead"><tr><th style="min-width:var(--valueCol);">金額</th></tr></thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>

      <!-- ★ 追加：①−⑥ の計算結果を表示する行 -->
      <div id="deltaCashChange" class="delta-box" aria-live="polite">
        現金｜Cash（① − ⑥）： <strong>¥0</strong>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <label for="paypay">② Paypay</label>
          <input type="number" id="paypay" name="paypay" min="0" step="1" inputmode="numeric" pattern="\d*"/>
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="uber">③ Uber</label>
          <input type="number" id="uber" name="uber" min="0" step="1" inputmode="numeric" pattern="\d*" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label for="demaekan">④ Demaekan</label>
          <input type="number" id="demaekan" name="demaekan" min="0" step="1" inputmode="numeric" pattern="\d*" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label>⑤ その他｜Tiền Khác</label>
          <input type="number" id="otherAmount" name="otherAmount" min="0" step="1" class="inline-input" placeholder="あれば加算｜Nếu có cộng vào" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="change">⑥ 釣り銭｜Tiền Thoái（-38,500）</label>
          <input type="number" id="change" name="change" value="-38500" step="1" class="inline-input" disabled />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="breakdown" style="margin-top:10px;">精算表｜Tiền Hóa Đơn</label>
          <input type="number" id="breakdown" name="breakdown" min="0" step="1" class="inline-input" placeholder="精算表額入力｜Nhập số tiền hóa đơn" required />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="notes" style="margin-top:10px;">備考｜Ghi chú</label>
          <textarea id="notes" name="notes" rows="3" class="note-input" placeholder="備考を入力 | Nhập ghi chú"></textarea>
        </div>

        <div style="flex:1; min-width:180px;">
          <div class="cash-box" id="subtotalDisplay">Cash + Paypay：¥0</div>
          <div class="total-box" id="totalDisplay" style="margin-top:6px;">①+②+③+④+⑤ - ⑥：¥0</div>
        </div>

        <div id="loginBox" aria-live="polite">
          <div class="actions">
            <input type="hidden" id="authUser" value="banhmi"/>
            <input id="authPass" type="password" placeholder="password" autocomplete="current-password" class="pass"/>
            <button id="submitBtn" type="button" style="flex:1; width:60%; min-width:50px;">送信 / Submit</button>
          </div>
        </div>
      </div>
    </form>

    <p class="note" style="margin-top:8px;">※パスワードセットが必要</br>Cần nhập password</p>
  </div>

  <script>
    /******************************
     *  設定（ここを置き換える）
     ******************************/
    const WEB_APP_URL = 'https://dailycash-rzzu.onrender.com/proxy';
    const SECRET_TOKEN = ''; // クライアント側でトークンを送らない運用なら空に

    /******************************
     * ログイン / 認証補助関数
     ******************************/
    const AUTH_KEY = 'proxyAuth'; // sessionStorage key
    function setAuthFromInputs() {
      const u = document.getElementById('authUser').value || '';
      const p = document.getElementById('authPass').value || '';
      if (!u || !p) { alert('パスワードを入力してください。\\nHãy nhập Password.'); return false; }
      const b = btoa(u + ':' + p);
      sessionStorage.setItem(AUTH_KEY, b);
      return true;
    }
    function clearAuth() { sessionStorage.removeItem(AUTH_KEY); updateLoginStatus(); }
    function getAuth() { return sessionStorage.getItem(AUTH_KEY) || null; }
    function updateLoginStatus() {
      document.getElementById('authPass').value = "";
      document.getElementById('authPass').disabled = false;
    }

    /******************************
     * グリッド生成（0..60 +「60以上」）
     ******************************/
    const DENOMS = [10000,5000,1000,500,100,50,10];
    const MAX_COL = 60;
    const colWidth = 40;
    const valueCol = 60;

    (function buildGrid(){
      const headRow = document.querySelector('#gridHead tr');
      for (let i=0;i<=MAX_COL;i++){
        const th = document.createElement('th');
        th.className='count-cell';
        th.style.minWidth = colWidth+'px';
        th.textContent = i;
        headRow.appendChild(th);
      }
      const thLast = document.createElement('th');
      thLast.className='count-cell';
      thLast.style.minWidth = colWidth+'px';
      thLast.textContent = MAX_COL + '以上';
      headRow.appendChild(thLast);

      const tbody = document.getElementById('gridBody');
      DENOMS.forEach(denom=>{
        const tr = document.createElement('tr');
        tr.dataset.denom = denom;

        const tdVal = document.createElement('td');
        tdVal.style.minWidth = valueCol + 'px';
        tdVal.textContent = '¥' + denom.toLocaleString();
        tr.appendChild(tdVal);

        for (let i = 0; i <= MAX_COL; i++) {
          const td = document.createElement('td');
          td.className='count-cell'; td.style.minWidth = colWidth+'px';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'count_' + denom;
          input.className = 'count-radio';
          input.value = String(i);
          td.appendChild(input);
          tr.appendChild(td);
        }

        const tdLast = document.createElement('td');
        tdLast.className='count-cell'; tdLast.style.minWidth = colWidth+'px';
        const rlast = document.createElement('input');
        rlast.type = 'radio'; rlast.name = 'count_' + denom; rlast.className = 'count-radio'; rlast.value = MAX_COL + 'plus';
        tdLast.appendChild(rlast);
        const inline = document.createElement('input');
        inline.type = 'number'; inline.min = MAX_COL; inline.step = 1; inline.className = 'inline-input hidden-count';
        inline.dataset.target = denom; inline.placeholder = '個数'; inline.style.display = 'none'; inline.style.marginLeft = '6px';
        tdLast.appendChild(inline);
        tr.appendChild(tdLast);

        tbody.appendChild(tr);
      });

      const table = document.getElementById('cashGrid');
      const totalCols = 1 + (MAX_COL + 1) + 1;
      const minW = valueCol + totalCols * colWidth;
      table.style.minWidth = Math.max(minW, 800) + 'px';
    })();

    /******************************
     * 入力制約＆UIトグル
     ******************************/
    (function uiToggles(){
      const locationSelect = document.getElementById('location');
      const locationOther = document.getElementById('locationOther');
      locationSelect.addEventListener('change', () => {
        if (locationSelect.value === 'other') { locationOther.style.display = 'block'; locationOther.required = true; }
        else { locationOther.style.display = 'none'; locationOther.required = false; }
      });
      const cashierSelect = document.getElementById('cashier');
      const cashierOther = document.getElementById('cashierOther');
      cashierSelect.addEventListener('change', () => {
        if (cashierSelect.value === 'other') { cashierOther.style.display = 'block'; cashierOther.required = true; }
        else { cashierOther.style.display = 'none'; cashierOther.required = false; }
      });
      function enforceIntegerInput(el) {
        el.addEventListener('input', () => { el.value = el.value.replace(/[^\\d]/g,''); });
        el.addEventListener('blur', () => { if (el.value==='') el.value='0'; });
      }
      ['paypay','uber','demaekan'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) enforceIntegerInput(el);
      });
    })();

    /******************************
     * 計算ロジック
     ******************************/
    function parseCountFromRow(row) {
      const radios = Array.from(row.querySelectorAll('input[type="radio"]'));
      const selected = radios.find(r => r.checked);
      if (!selected) return 0;
      if ((selected.value||'').endsWith('plus')) {
        const inline = row.querySelector('.hidden-count');
        const v = inline && inline.value ? parseInt(inline.value,10) : NaN;
        return isNaN(v) ? 0 : v;
      }
      const n = parseInt(selected.value || '0',10);
      return isNaN(n) ? 0 : n;
    }

    function computeGridTotalAndCounts() {
      const rows = Array.from(document.querySelectorAll('#cashGrid tbody tr'));
      let gridTotal = 0;
      const denom_counts = {};
      rows.forEach(row => {
        const denom = Number(row.dataset.denom || 0);
        const cnt = parseCountFromRow(row);
        denom_counts[String(denom)] = cnt;
        gridTotal += denom * (isNaN(cnt) ? 0 : cnt);
      });
      return {gridTotal, denom_counts};
    }

    function updateDisplays() {
      const {gridTotal} = computeGridTotalAndCounts();
      const other = parseInt(document.getElementById('otherAmount').value || '0',10) || 0;
      const change = parseInt(document.getElementById('change').value || '0',10) || 0; // -38500（固定）
      const paypay = parseInt(document.getElementById('paypay').value || '0',10) || 0;
      const uber = parseInt(document.getElementById('uber').value || '0',10) || 0;
      const demaekan = parseInt(document.getElementById('demaekan').value || '0',10) || 0;

      // ★ ①−⑥（= gridTotal - change）: change は負数（-38500）なので「① + 38,500」になる
      const cashMinusChange = gridTotal + change;
      document.getElementById('deltaCashChange').innerHTML =
        '現金｜Cash（① − ⑥）： <strong>¥' + cashMinusChange.toLocaleString() + '</strong>';

      // 既存の集計（元ファイルの仕様を維持）
      const cashTotal = gridTotal + change + other;
      const subtotal = cashTotal + paypay;
      const overall = subtotal + uber + demaekan;

      document.getElementById('subtotalDisplay').textContent = 'Cash + Paypay：¥' + subtotal.toLocaleString();
      document.getElementById('totalDisplay').textContent = '①+②+③+④+⑤ - ⑥：¥' + overall.toLocaleString();
    }

    (function attachUpdateListeners(){
      // グリッドのラジオ＆「60以上」入力
      document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
        row.querySelectorAll('input[type="radio"]').forEach(radio=>{
          radio.addEventListener('change', (e)=>{
            const inline = row.querySelector('.hidden-count');
            if (inline) inline.style.display = (radio.value.endsWith('plus')) ? 'inline-block' : 'none';
            if (!radio.value.endsWith('plus') && inline) inline.value = '';
            updateDisplays();
          });
        });
        const inline = row.querySelector('.hidden-count');
        if (inline) inline.addEventListener('input', updateDisplays);
      });

      // その他の入力
      ['paypay','uber','demaekan','otherAmount','change'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateDisplays);
      });

      // 初期値：各行 0 を選択
      document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
        const r0 = row.querySelector('input[type="radio"][value="0"]');
        if (r0) r0.checked = true;
      });

      // 初回描画
      updateDisplays();
    })();

    /******************************
     * 送信（Authorization ヘッダを付与）
     ******************************/
    function collectDenomCounts() {
      const rows = Array.from(document.querySelectorAll('#cashGrid tbody tr'));
      const denom_counts = {};
      let grid_total = 0;
      rows.forEach(row => {
        const denom = Number(row.dataset.denom || 0);
        const cnt = parseCountFromRow(row);
        denom_counts[String(denom)] = cnt;
        grid_total += denom * (isNaN(cnt) ? 0 : cnt);
      });
      return {denom_counts, grid_total};
    }

    async function submitToAppsScript() {
      if (!document.getElementById('authPass').value) { alert('パスワードを入力してください。\\nHãy nhập Password.'); return; }
      setAuthFromInputs();

      const date = document.getElementById('date').value;
      if (!date) { alert('日付を入力してください。\\nHãy nhập ngày tháng.'); return; }
      const location = document.getElementById('location').value === 'other' ? document.getElementById('locationOther').value : document.getElementById('location').value;
      if (!location) { alert('店舗を入力してください。\\nHãy chọn tên tiệm.'); return; }
      const cashier = document.getElementById('cashier').value === 'other' ? document.getElementById('cashierOther').value : document.getElementById('cashier').value;
      if (!cashier) { alert('担当者を入力してください\\nHãy chọn member.'); return; }
      if (!document.getElementById('breakdown').value) { alert('精算表金額を入力してください。\\nHãy nhập số tiền trên hóa đơn.'); return; }

      const auth = getAuth();
      if (!auth) { alert('送信にはログインが必要です。\\nCần Login trước khi gửi dữ liệu.'); return; }

      const {denom_counts, grid_total} = collectDenomCounts();
      const change = Number(document.getElementById('change').value || 0);
      const other = Number(document.getElementById('otherAmount').value || 0);
      const paypay = Number(document.getElementById('paypay').value || 0);
      const uber = Number(document.getElementById('uber').value || 0);
      const demaekan = Number(document.getElementById('demaekan').value || 0);
      const breakdown = document.getElementById('breakdown').value || '';
      const notes = document.getElementById('notes').value || '';

      const fd = new FormData();
      if (SECRET_TOKEN) fd.append('token', SECRET_TOKEN);
      fd.append('date', date);
      fd.append('location', location);
      fd.append('cashier', cashier);
      fd.append('grid_total', String(grid_total));
      fd.append('change', String(change));
      fd.append('other', String(other));
      fd.append('paypay', String(paypay));
      fd.append('uber', String(uber));
      fd.append('demaekan', String(demaekan));
      fd.append('breakdown', breakdown);
      fd.append('notes', notes);
      Object.keys(denom_counts).forEach(k => { fd.append('count_' + k, String(denom_counts[k])); });

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '　送信中... 　';

      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Authorization': 'Basic ' + auth },
          body: fd
        });

        if (res.status === 401) {
          clearAuth();
          alert('パスワードが不正、認証に失敗しました。\\nSai Password, Login không thành công.');
          return;
        }

        const data = await res.json();
        if (data && data.status === 'ok') {
          alert('送信が完了しました。\\nĐã gửi dữ liệu thành công!');
          document.getElementById('dailyCashForm').reset();
          document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
            const r0 = row.querySelector('input[type="radio"][value="0"]');
            if (r0) r0.checked = true;
            const inline = row.querySelector('.hidden-count');
            if (inline) { inline.value=''; inline.style.display='none'; }
          });
          updateDisplays();
        } else {
          console.error('Apps Script error', data);
          alert('送信に失敗しました: ' + (data && data.message ? data.message : '不明なエラー'));
        }
      } catch (err) {
        clearAuth();
        console.error(err);
        alert('送信時にエラーが発生しました。管理者へ連絡してください。\\nPhát sinh lỗi, xin hãy liên hệ với quản lý.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '送信 / Submit';
      }
    }

    document.getElementById('submitBtn').addEventListener('click', submitToAppsScript);
  </script>
</body>
</html>