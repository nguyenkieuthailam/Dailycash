<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æ—¥æ¬¡å£²ä¸Šé‡‘é›†é‡‘ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆApps Scripté€ä¿¡ï¼‰</title>
  <style>
    :root{--colWidth:64px; --valueCol:120px}
    body { font-family: Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background:#f7f9fc; padding:18px; color:#111; }
    .container { max-width:1200px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
    h1 { margin:0 0 6px; font-size:1.18rem; }
    .subtitle { color:#546e7a; margin-bottom:12px; }
    label { display:block; margin:12px 0 6px; font-weight:700; }
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
      width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; box-sizing:border-box; font-size:0.95rem;
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:180px; }
    .actions { margin-top:18px; text-align:right; }
    button { background:#0b69d6; color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-size:0.95rem; }
    .note { color:#666; font-size:0.9rem; margin-top:8px; }

    /* login box */
    #loginBox { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    #loginBox input { width:auto; display:inline-block; padding:6px 8px; font-size:0.9rem; }
    #loginBox button { padding:6px 10px; font-size:0.9rem; }

    /* grid */
    .grid-wrapper { width:100%; overflow-x:auto; border:1px solid #e6eef8; border-radius:8px; background:#fff; margin-top:10px; }
    table.grid { border-collapse:collapse; table-layout:fixed; min-width:100%; }
    .grid th, .grid td { border-right:1px solid #eef6ff; border-bottom:1px solid #eef6ff; padding:8px 6px; text-align:center; font-size:0.9rem; white-space:nowrap; }
    .grid th { background:#f0f6ff; color:#0b69d6; font-weight:700; position:sticky; top:0; z-index:5; }
    .grid th:first-child, .grid td:first-child { position:sticky; left:0; z-index:7; background:#fff; text-align:left; padding-left:12px; min-width:var(--valueCol); }
    .count-cell { width:var(--colWidth); max-width:var(--colWidth); padding:6px; }
    .inline-input { width:72px; padding:6px; border-radius:6px; border:1px solid #cbd6e6; font-size:0.9rem; }
    .total-box { margin-top:12px; font-weight:700; color:#0b69d6; }
    .help { color:#555; font-size:0.92rem; margin-top:6px; }
    @media (max-width:700px){
      :root{--valueCol:100px; --colWidth:52px}
      .container { padding:12px; }
    }

    /* Login block â€” vertical layout, same style as other form fields */
    #loginBox {
      display: block;
      margin-bottom: 12px;
      padding: 8px 0;
    }
    #loginBox .field {
      margin-top: 8px;
    }
    #loginBox .field label {
      display:block;
      margin-bottom:6px;
      font-weight:700;
      font-size:0.95rem;
    }
    #loginBox .field input {
      /* reuse existing global input style (width:100% etc) */
      width:100%;
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #d1d5db;
      box-sizing:border-box;
      font-size:0.95rem;
    }
    #loginBox .pw-row {
      display:flex;
      gap:8px;
      align-items:center;
    }
    #loginBox .pw-row input[type="password"],
    #loginBox .pw-row input[type="text"] {
      flex:1;
    }
    #loginBox .pw-toggle {
      background:transparent;
      border:1px solid #d1d5db;
      border-radius:6px;
      padding:8px 10px;
      cursor:pointer;
      font-size:0.95rem;
    }
    #loginBox .actions {
      display:flex;
      gap:8px;
      margin-top:10px;
      justify-content:flex-end;
    }
    #loginBox .btn {
      padding:8px 12px;
      border-radius:6px;
      border:none;
      background:#0b69d6;
      color:#fff;
      cursor:pointer;
    }
    #loginBox .btn.secondary {
      background:#eef5ff;
      color:#0b69d6;
      border:1px solid #dbeeff;
    }
    #loginStatus {
      margin-top:8px;
      color:#666;
      font-size:0.95rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æ—¥æ¬¡å£²ä¸Šé‡‘é›†é‡‘ãƒ•ã‚©ãƒ¼ãƒ </h1>
    <div class="subtitle">Daily cash / é›†é‡‘å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </div>

    <!-- LOGIN UI 
    <div id="loginBox" aria-live="polite">
      <input id="authUser" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" />
      <input id="authPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" type="password" />
      <button id="authBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="logoutBtn" style="display:none;background:#666;margin-left:4px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <div id="loginStatus" style="margin-left:12px;color:#666;font-size:0.95rem;"></div>
    </div> -->

    <!-- LOGIN UI (vertical, same style as other fields) -->
    <div id="loginBox" aria-live="polite">
      <div class="field">
        <label for="authUser">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        <input id="authUser" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" autocomplete="username" />
      </div>

      <div class="field">
        <label for="authPass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <div class="pw-row">
          <input id="authPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" />
          <button type="button" id="pwToggle" class="pw-toggle" aria-pressed="false" title="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿">ğŸ‘</button>
        </div>
      </div>

      <div class="actions">
        <button id="authBtn" class="btn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="btn secondary" type="button" style="display:none">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div id="loginStatus">æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šé€ä¿¡å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
    </div>

    <p class="note">ã‚°ãƒªãƒƒãƒ‰ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚å·¦ç«¯ã®ã€Œé‡‘é¡ã€åˆ—ã¯å›ºå®šè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

    <form id="dailyCashForm" onsubmit="return false;">
      <label for="date">æ—¥ä»˜ (Date)</label>
      <input type="date" id="date" name="date" required />

      <label for="location">åº—èˆ— / æ‹ ç‚¹ (Location)</label>
      <select id="location" name="location" required>
        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        <option value="chigasaki">èŒ…ãƒ¶å´åº—</option>
        <option value="yokohama">æ¨ªæµœåº—</option>
        <option value="tokyo">æ±äº¬æœ¬åº—</option>
        <option value="osaka">å¤§é˜ªæ”¯åº—</option>
        <option value="other">ãã®ä»–ï¼ˆè¨˜å…¥ï¼‰</option>
      </select>
      <input type="text" id="locationOther" placeholder="åº—èˆ—åã‚’å…¥åŠ›" style="margin-top:8px; display:none;" />

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label for="cashier">æ‹…å½“è€…å (Cashier)</label>
          <select id="cashier" name="cashier" required>
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
            <option value="sato">ä½è—¤</option>
            <option value="suzuki">éˆ´æœ¨</option>
            <option value="tanaka">ç”°ä¸­</option>
            <option value="yamada">å±±ç”°</option>
            <option value="other">ãã®ä»–ï¼ˆè¨˜å…¥ï¼‰</option>
          </select>
          <input type="text" id="cashierOther" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›" style="margin-top:8px; display:none;" />
        </div>
      </div>

      <label style="margin-top:12px;">é›†é‡‘é¡ï¼ˆç¾é‡‘ï¼‰ (Cash collected) â€” ã‚°ãƒªãƒƒãƒ‰å…¥åŠ›</label>
      <div class="help">åˆ—ã§å€‹æ•°ï¼ˆ0ã€œ60ãƒ»60ä»¥ä¸Šï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚åˆè¨ˆï¼ˆç¾é‡‘åˆè¨ˆï¼‰ã¯è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</div>

      <div class="grid-wrapper" id="gridWrapper">
        <table class="grid" id="cashGrid">
          <thead id="gridHead"><tr><th style="min-width:var(--valueCol);">é‡‘é¡</th></tr></thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:160px;">
          <label for="paypay">Paypayå£²ä¸Š</label>
          <input type="number" id="paypay" name="paypay" min="0" step="1" inputmode="numeric" pattern="\d*" value="0" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label for="uber">Uberå£²ä¸Š</label>
          <input type="number" id="uber" name="uber" min="0" step="1" inputmode="numeric" pattern="\d*" value="0" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label for="demaekan">Demaekanå£²ä¸Š</label>
          <input type="number" id="demaekan" name="demaekan" min="0" step="1" inputmode="numeric" pattern="\d*" value="0" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="change">é‡£ã‚ŠéŠ­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ -38,500ï¼‰</label>
        <input type="number" id="change" name="change" value="-38500" step="1" class="inline-input" />
      </div>

      <div style="margin-top:10px;">
        <label>ãã®ä»–ï¼ˆé‡‘é¡ãŒã‚ã‚Œã°åŠ ç®—ï¼‰</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="number" id="otherAmount" name="otherAmount" min="0" step="1" class="inline-input" placeholder="ä¾‹: 250" />
          <div class="help">ï¼ˆå°è¨ˆã«ä¸Šä¹—ã›ã•ã‚Œã¾ã™ï¼‰</div>
        </div>
      </div>

      <div class="total-box" id="subtotalDisplay">é›†é‡‘+Paypay åˆè¨ˆï¼šÂ¥0</div>
      <div class="total-box" id="totalDisplay" style="margin-top:6px;">ç·å£²ä¸Šï¼ˆè‡ªå‹•ï¼‰ï¼šÂ¥0</div>

      <label for="breakdown" style="margin-top:12px;">å£²ä¸Šå†…è¨³ï¼ˆä»»æ„ï¼‰(Sales breakdown)</label>
      <textarea id="breakdown" name="breakdown" rows="4" placeholder="å•†å“A: 5000ã€å•†å“B: 7000 ãªã©"></textarea>

      <label for="notes" style="margin-top:10px;">å‚™è€ƒ / Notes</label>
      <textarea id="notes" name="notes" rows="3" placeholder="ä¸å‚™ã‚„ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜è¼‰"></textarea>

      <div class="actions">
        <button id="submitBtn" type="button">é€ä¿¡ / Submit</button>
      </div>
    </form>

    <p class="note" style="margin-top:12px;">â€»FormDataã§é€ä¿¡ã—ã¾ã™ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <script>
    /******************************
     *  è¨­å®šï¼ˆã“ã“ã‚’ç½®ãæ›ãˆã‚‹ï¼‰
     ******************************/
    const WEB_APP_URL = 'https://dailycash-rzzu.onrender.com/proxy';
    const SECRET_TOKEN = ''; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‰ãªã„é‹ç”¨ãªã‚‰ç©ºã«

    /******************************
     * ãƒ­ã‚°ã‚¤ãƒ³ / èªè¨¼è£œåŠ©é–¢æ•°
     ******************************/
    const AUTH_KEY = 'proxyAuth'; // sessionStorage key

    function setAuthFromInputs() {
      const u = document.getElementById('authUser').value || '';
      const p = document.getElementById('authPass').value || '';
      if (!u || !p) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return false;
      }
      const b = btoa(u + ':' + p);
      sessionStorage.setItem(AUTH_KEY, b);
      updateLoginStatus();
      return true;
    }

    function clearAuth() {
      sessionStorage.removeItem(AUTH_KEY);
      updateLoginStatus();
    }

    function getAuth() {
      return sessionStorage.getItem(AUTH_KEY) || null;
    }

    function updateLoginStatus() {
      const statusEl = document.getElementById('loginStatus');
      const logoutBtn = document.getElementById('logoutBtn');
      const auth = getAuth();
      if (auth) {
        statusEl.textContent = 'èªè¨¼æ¸ˆã¿ï¼ˆé€ä¿¡æ™‚ã«ãƒ—ãƒ­ã‚­ã‚·ã¸èªè¨¼æƒ…å ±ã‚’ä»˜ä¸ã—ã¾ã™ï¼‰';
        logoutBtn.style.display = 'inline-block';
        document.getElementById('authUser').style.display = 'none';
        document.getElementById('authPass').style.display = 'none';
        document.getElementById('authBtn').style.display = 'none';
      } else {
        statusEl.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šé€ä¿¡å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
        logoutBtn.style.display = 'none';
        document.getElementById('authUser').style.display = 'inline-block';
        document.getElementById('authPass').style.display = 'inline-block';
        document.getElementById('authBtn').style.display = 'inline-block';
      }
    }

    // password toggle â€” æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨ä½µç”¨ã§ãã¾ã™
    document.addEventListener('DOMContentLoaded', () => {
      const pwToggle = document.getElementById('pwToggle');
      const passInput = document.getElementById('authPass');
      if (pwToggle && passInput) {
        pwToggle.addEventListener('click', () => {
          const isPwd = passInput.getAttribute('type') === 'password';
          passInput.setAttribute('type', isPwd ? 'text' : 'password');
          pwToggle.setAttribute('aria-pressed', String(isPwd));
          pwToggle.textContent = isPwd ? 'ğŸ™ˆ' : 'ğŸ‘';
        });
      }

      // æ—¢å­˜ã® updateLoginStatus() ã‚’å‘¼ã‚“ã§åˆæœŸçŠ¶æ…‹åæ˜ ï¼ˆã‚‚ã—å®šç¾©æ¸ˆã¿ãªã‚‰ï¼‰
      if (typeof updateLoginStatus === 'function') updateLoginStatus();
    });

    document.getElementById('authBtn').addEventListener('click', () => {
      if (setAuthFromInputs()) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šï¼‰ã€‚é€ä¿¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
      clearAuth();
      alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
    });

    // initialize status on load
    updateLoginStatus();

    /******************************
     * ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆï¼ˆ0..60 +ã€Œ60ä»¥ä¸Šã€ï¼‰
     ******************************/
    const DENOMS = [10000,5000,1000,500,100,50,10];
    const MAX_COL = 60;
    const colWidth = 64;
    const valueCol = 120;

    (function buildGrid(){
      const headRow = document.querySelector('#gridHead tr');
      for (let i=0;i<=MAX_COL;i++){
        const th = document.createElement('th');
        th.className='count-cell';
        th.style.minWidth = colWidth+'px';
        th.textContent = i;
        headRow.appendChild(th);
      }
      const thLast = document.createElement('th');
      thLast.className='count-cell';
      thLast.style.minWidth = colWidth+'px';
      thLast.textContent = MAX_COL + 'ä»¥ä¸Š';
      headRow.appendChild(thLast);

      const tbody = document.getElementById('gridBody');
      DENOMS.forEach(denom=>{
        const tr = document.createElement('tr');
        tr.dataset.denom = denom;

        const tdVal = document.createElement('td');
        tdVal.style.minWidth = valueCol + 'px';
        tdVal.textContent = 'Â¥' + denom.toLocaleString();
        tr.appendChild(tdVal);

        for (let i = 0; i <= MAX_COL; i++) {
          const td = document.createElement('td');
          td.className='count-cell'; td.style.minWidth = colWidth+'px';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'count_' + denom;
          input.className = 'count-radio';
          input.value = String(i);
          td.appendChild(input);
          tr.appendChild(td);
        }

        const tdLast = document.createElement('td');
        tdLast.className='count-cell'; tdLast.style.minWidth = colWidth+'px';
        const rlast = document.createElement('input');
        rlast.type = 'radio'; rlast.name = 'count_' + denom; rlast.className = 'count-radio'; rlast.value = MAX_COL + 'plus';
        tdLast.appendChild(rlast);
        const inline = document.createElement('input');
        inline.type = 'number'; inline.min = MAX_COL; inline.step = 1; inline.className = 'inline-input hidden-count';
        inline.dataset.target = denom; inline.placeholder = 'å€‹æ•°'; inline.style.display = 'none'; inline.style.marginLeft = '6px';
        tdLast.appendChild(inline);
        tr.appendChild(tdLast);

        tbody.appendChild(tr);
      });

      const table = document.getElementById('cashGrid');
      const totalCols = 1 + (MAX_COL + 1) + 1;
      const minW = valueCol + totalCols * colWidth;
      table.style.minWidth = Math.max(minW, 800) + 'px';
    })();

    /******************************
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›åˆ¶å¾¡ï¼ˆlocation/cashier ãã®ä»–ãªã©ï¼‰
     ******************************/
    (function uiToggles(){
      const locationSelect = document.getElementById('location');
      const locationOther = document.getElementById('locationOther');
      locationSelect.addEventListener('change', () => {
        if (locationSelect.value === 'other') { locationOther.style.display = 'block'; locationOther.required = true; }
        else { locationOther.style.display = 'none'; locationOther.required = false; }
      });
      const cashierSelect = document.getElementById('cashier');
      const cashierOther = document.getElementById('cashierOther');
      cashierSelect.addEventListener('change', () => {
        if (cashierSelect.value === 'other') { cashierOther.style.display = 'block'; cashierOther.required = true; }
        else { cashierOther.style.display = 'none'; cashierOther.required = false; }
      });
    })();

    /******************************
     * å…¥åŠ›åˆ¶ç´„ï¼ˆPaypay/Uber/Demaekan ã‚’æ•°å€¤ã®ã¿ã«ï¼‰
     ******************************/
    function enforceIntegerInput(el) {
      el.addEventListener('input', () => {
        let v = el.value;
        v = v.replace(/[^\d]/g,'');
        el.value = v;
      });
      el.addEventListener('blur', () => { if (el.value==='') el.value='0'; });
    }
    ['paypay','uber','demaekan'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) enforceIntegerInput(el);
    });

    /******************************
     * è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé›†è¨ˆãƒ»è¡¨ç¤ºï¼‰
     ******************************/
    function parseCountFromRow(row) {
      const radios = Array.from(row.querySelectorAll('input[type="radio"]'));
      const selected = radios.find(r => r.checked);
      if (!selected) return 0;
      if ((selected.value||'').endsWith('plus')) {
        const inline = row.querySelector('.hidden-count');
        const v = inline && inline.value ? parseInt(inline.value,10) : NaN;
        return isNaN(v) ? 0 : v;
      }
      const n = parseInt(selected.value || '0',10);
      return isNaN(n) ? 0 : n;
    }

    function computeGridTotalAndCounts() {
      const rows = Array.from(document.querySelectorAll('#cashGrid tbody tr'));
      let gridTotal = 0;
      const denom_counts = {};
      rows.forEach(row => {
        const denom = Number(row.dataset.denom || 0);
        const cnt = parseCountFromRow(row);
        denom_counts[String(denom)] = cnt;
        gridTotal += denom * (isNaN(cnt) ? 0 : cnt);
      });
      return {gridTotal, denom_counts};
    }

    function updateDisplays() {
      const {gridTotal} = computeGridTotalAndCounts();
      const other = parseInt(document.getElementById('otherAmount').value || '0',10) || 0;
      const change = parseInt(document.getElementById('change').value || '0',10) || 0;
      const paypay = parseInt(document.getElementById('paypay').value || '0',10) || 0;
      const uber = parseInt(document.getElementById('uber').value || '0',10) || 0;
      const demaekan = parseInt(document.getElementById('demaekan').value || '0',10) || 0;

      const cashTotal = gridTotal + change + other;
      const subtotal = cashTotal + paypay;
      const overall = subtotal + uber + demaekan;

      document.getElementById('subtotalDisplay').textContent = 'é›†é‡‘+Paypay åˆè¨ˆï¼šÂ¥' + subtotal.toLocaleString();
      document.getElementById('totalDisplay').textContent = 'ç·å£²ä¸Šï¼ˆè‡ªå‹•ï¼‰ï¼šÂ¥' + overall.toLocaleString();
    }

    (function attachUpdateListeners(){
      document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
        row.querySelectorAll('input[type="radio"]').forEach(radio=>{
          radio.addEventListener('change', (e)=>{
            const inline = row.querySelector('.hidden-count');
            if (inline) inline.style.display = (radio.value.endsWith('plus')) ? 'inline-block' : 'none';
            if (!radio.value.endsWith('plus') && inline) inline.value = '';
            updateDisplays();
          });
        });
        const inline = row.querySelector('.hidden-count');
        if (inline) inline.addEventListener('input', updateDisplays);
      });

      ['paypay','uber','demaekan','otherAmount','change'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateDisplays);
      });

      document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
        const r0 = row.querySelector('input[type="radio"][value="0"]');
        if (r0) r0.checked = true;
      });
      updateDisplays();
    })();

    /******************************
     * åé›†ãƒ­ã‚¸ãƒƒã‚¯ã¨é€ä¿¡ï¼ˆAuthorization ãƒ˜ãƒƒãƒ€ã‚’ä»˜ä¸ï¼‰
     ******************************/
    function collectDenomCounts() {
      const rows = Array.from(document.querySelectorAll('#cashGrid tbody tr'));
      const denom_counts = {};
      let grid_total = 0;
      rows.forEach(row => {
        const denom = Number(row.dataset.denom || 0);
        const cnt = parseCountFromRow(row);
        denom_counts[String(denom)] = cnt;
        grid_total += denom * (isNaN(cnt) ? 0 : cnt);
      });
      return {denom_counts, grid_total};
    }

    async function submitToAppsScript() {
      // basic validation
      const date = document.getElementById('date').value;
      if (!date) { alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const location = document.getElementById('location').value === 'other' ? document.getElementById('locationOther').value : document.getElementById('location').value;
      if (!location) { alert('åº—èˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const cashier = document.getElementById('cashier').value === 'other' ? document.getElementById('cashierOther').value : document.getElementById('cashier').value;
      if (!cashier) { alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

      const auth = getAuth();
      if (!auth) { alert('é€ä¿¡ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ä¸Šéƒ¨ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

      const {denom_counts, grid_total} = collectDenomCounts();
      const change = Number(document.getElementById('change').value || 0);
      const other = Number(document.getElementById('otherAmount').value || 0);
      const paypay = Number(document.getElementById('paypay').value || 0);
      const uber = Number(document.getElementById('uber').value || 0);
      const demaekan = Number(document.getElementById('demaekan').value || 0);
      const breakdown = document.getElementById('breakdown').value || '';
      const notes = document.getElementById('notes').value || '';

      const fd = new FormData();
      // only append token if non-empty (we prefer server INJECT_TOKEN)
      if (SECRET_TOKEN) fd.append('token', SECRET_TOKEN);
      fd.append('date', date);
      fd.append('location', location);
      fd.append('cashier', cashier);
      fd.append('grid_total', String(grid_total));
      fd.append('change', String(change));
      fd.append('other', String(other));
      fd.append('paypay', String(paypay));
      fd.append('uber', String(uber));
      fd.append('demaekan', String(demaekan));
      fd.append('breakdown', breakdown);
      fd.append('notes', notes);
      Object.keys(denom_counts).forEach(k => { fd.append('count_' + k, String(denom_counts[k])); });

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'é€ä¿¡ä¸­...';

      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Authorization': 'Basic ' + auth
          },
          body: fd
        });

        if (res.status === 401) {
          // authentication failed at proxy - clear stored auth
          clearAuth();
          alert('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const data = await res.json();
        if (data && data.status === 'ok') {
          alert('é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
          document.getElementById('dailyCashForm').reset();
          document.querySelectorAll('#cashGrid tbody tr').forEach(row=>{
            const r0 = row.querySelector('input[type="radio"][value="0"]');
            if (r0) r0.checked = true;
            const inline = row.querySelector('.hidden-count');
            if (inline) { inline.value=''; inline.style.display='none'; }
          });
          updateDisplays();
        } else {
          console.error('Apps Script error', data);
          alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data && data.message ? data.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
      } catch (err) {
        console.error(err);
        alert('é€ä¿¡æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'é€ä¿¡ / Submit';
      }
    }

    // attach submit handler
    document.getElementById('submitBtn').addEventListener('click', submitToAppsScript);
  </script>
</body>
</html>